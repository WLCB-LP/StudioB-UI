<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!--
    IMPORTANT:
    This UI is served as static files behind nginx.
    Browsers can aggressively cache index.html/app.js/styles.css, which can cause
    an operator to *appear* stuck on an older UI after an update.

    We deliberately ask the browser not to cache index.html so it can quickly
    discover the new cache-busted asset URLs after an update.
  -->
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>WLCB • Studio B</title>
  <link rel="stylesheet" href="/styles.css?v=0.3.12" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__title">WLCB • Studio B</div>
      <div class="brand__sub">Operator Console</div>
    </div>

    <nav class="tabs" aria-label="Pages">
      <button class="tab active" data-page="studio" aria-current="page">Studio</button>
      <button class="tab" data-page="engineering">Engineering</button>
    </nav>

    <div class="status">
      <div class="pill" id="connStatus">Connecting…</div>
      <!--
        Update pill:
        - ALWAYS visible as the operator's "jump to Engineering" shortcut.
        - Styling + tooltip change ONLY when an update is actually available.

        IMPORTANT:
        StudioB supports decoupled versioning (UI can update while engine is pinned).
        Therefore "update available" must be UI-version-based and must NOT be inferred
        from engine/runtime versions.
      -->
      <button class="pill pill--muted" id="updatePill" type="button" title="Check for updates">Update</button>
      <div class="pill pill--muted" id="uiVerPill">ui v—</div>
      <div class="pill pill--muted" id="verPill">engine v—</div>
      <div class="pill pill--muted" id="modePill">engine: —</div>
      <div class="pill pill--muted" id="dspConnPill">dsp: —</div>
      <div class="pill pill--muted" id="dspWritePill">dsp writes: —</div>
    </div>
  </header>

  <!-- Engineering unlock modal -->
  <div class="modal hidden" id="pinModal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="modal__panel">
      <h2 id="pinTitle">Engineering Unlock</h2>
      <p class="muted">Enter the admin PIN to access Engineering controls.</p>
      <div class="row">
        <input class="text" id="pinInput" type="password" placeholder="Admin PIN" autocomplete="current-password" />
      </div>
      <div class="row row--right">
        <button class="btn" id="btnPinCancel">Cancel</button>
        <button class="btn ok" id="btnPinUnlock">Unlock</button>
      </div>
      <div class="small" id="pinMsg"></div>
    </div>
  </div>

  <main>
    <section id="page-studio" class="page">
      <div class="studioLayout">
        <div class="stack">
          <div class="card">
            <div class="card__head">
              <h2>Mics</h2>
              <div class="hint">Auto-mutes speakers when any mic is live.</div>
            </div>
            <div class="controls grid4">
              <button class="btn toggle" data-rc="STUB_MIC_HOST">Host</button>
              <button class="btn toggle" data-rc="STUB_MIC_GUEST_1">Guest 1</button>
              <button class="btn toggle" data-rc="STUB_MIC_GUEST_2">Guest 2</button>
              <button class="btn toggle" data-rc="STUB_MIC_GUEST_3">Guest 3</button>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <h2>Speakers</h2>
              <div class="lamps">
                <div class="lamp" id="lampAutoMute" title="Automatic mute (logic-controlled)">
                  <div class="dot"></div>
                  <div class="txt">AUTO-MUTED</div>
                </div>
              </div>
            </div>

            <label class="row">
              <span class="row__label">Level</span>
              <input type="range" min="0" max="1" step="0.01" value="0.70" data-rc="STUB_SPK_LEVEL" class="slider" />
              <span class="val" data-val-for="STUB_SPK_LEVEL">—</span>
            </label>

            <div class="row">
              <span class="row__label">Mute</span>
              <button class="btn toggle" data-rc="STUB_SPK_MUTE">Speaker Mute</button>
              <span class="muted small" id="spkMuteNote"></span>
            </div>
          </div>

          <div class="card card--thin">
            <div class="row">
              <button class="btn" id="btnReconnect">Reconnect DSP</button>
              <button class="btn" id="btnDspTest">Test DSP Now</button>
              <span class="muted" id="dspTestMsg"></span>
              
<div class="banner warn" id="dspTransitionBanner" style="display:none;">
  <strong>DSP LIVE MODE WARNING</strong><br/>
  DSP has entered LIVE mode, but the link has not been validated yet.<br/>
<span class="muted">Endpoint:</span> <span id="dspBannerEndpoint">—</span><br/>
<span class="muted">Last validated:</span> <span id="dspBannerValidatedAge">—</span><br/>
<span class="muted" id="dspBannerConfigChanged" style="display:none;">⚠ DSP config changed since last validation.</span><br/>
  <button class="btn" id="btnDspBannerTest">Test DSP Now</button>
  <button class="btn" id="btnDspBannerAck">Acknowledge</button>
</div>
<div class="card dspHealth">

                <div class="card__title">DSP Health</div>
                <div class="kv"><span class="k">State</span><span class="v" id="dspHealthState">—</span></div>
                <div class="kv"><span class="k">Last OK</span><span class="v" id="dspHealthLastOk">—</span></div>
                <div class="kv"><span class="k">Failures</span><span class="v" id="dspHealthFails">—</span></div>
                <div class="kv"><span class="k">Last Error</span><span class="v" id="dspHealthErr">—</span></div>
                <div class="kv"><span class="k">Last Test</span><span class="v" id="dspHealthLastTest">—</span></div>
                <div class="kv"><span class="k">Last Poll</span><span class="v" id="dspHealthLastPoll">—</span></div>
                <div class="warn" id="dspControlWarn" style="display:none;"></div>
              </div>
              <div class="card dspTimeline">
                <div class="card__title">DSP Health Timeline (recent)</div>
                <pre class="log" id="dspTimeline">—</pre>
              </div>
              <span class="small muted" id="reconnectMsg"></span>
            </div>
          </div>
        </div>

        <div class="metersCol">
          <div class="card">
            <div class="card__head">
              <h2>Program</h2>
              <div class="hint">On-air mix</div>
            </div>
            <div class="meters">
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_pgmL"></div></div>
                <div class="meter__lbl">L</div>
              </div>
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_pgmR"></div></div>
                <div class="meter__lbl">R</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <h2>Speakers</h2>
              <div class="hint">Studio speaker output</div>
            </div>
            <div class="meters">
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_spkL"></div></div>
                <div class="meter__lbl">L</div>
              </div>
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_spkR"></div></div>
                <div class="meter__lbl">R</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <h2>Remote Studio Return</h2>
              <div class="hint">Call / remote return</div>
            </div>
            <div class="meters">
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_rsrL"></div></div>
                <div class="meter__lbl">L</div>
              </div>
              <div class="meter">
                <div class="meter__bar"><div class="fill" id="m_rsrR"></div></div>
                <div class="meter__lbl">R</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-engineering" class="page hidden">
      <h1 class="pageTitle">Engineering</h1>

      <div class="grid">
        <div class="card">
          <h2>Admin</h2>
          <div class="row">
            <input class="text" id="adminPin" type="password" placeholder="Admin PIN" autocomplete="current-password" />
          </div>
          <div class="row">
            <button class="btn warn" id="btnUpdate">Update (Release)</button>
            <button class="btn warn" id="btnRollback">Rollback…</button>
          </div>
          <div class="small" id="svcMsg"></div>
          <div class="small" id="updateCheckMsg"></div>

          <div class="row">
            <!--
              Update/rollback can legitimately require the operator to refresh the browser
              to pick up new cache-busted UI assets (index.html/app.js/styles.css).
              We keep this as an explicit operator action for production safety.
            -->
            <button class="btn ok hidden" id="btnRefresh">Refresh Now</button>
            <button class="btn hidden" id="btnSvcClear" title="Clear the message below">Clear</button>
          </div>

        </div>


        <div class="card">
          <h2>Configuration</h2>
          <!--
            Persisted vs runtime clarity (UI v0.3.07+)

            Operators frequently expect this panel to reflect *what is running right now*.
            In reality, this editor controls the persisted file on disk, which only fully
            takes effect after an engine restart (watchdog may restart automatically).

            Runtime mode may differ if the watchdog promoted/overrode the running engine
            without writing back to disk.
          -->
          <div class="small">Persisted config (applies on restart). Edits <code>~/.StudioB-UI/config/config.v1</code>.</div>
          <div class="small cfg-clarity">
            <span class="muted">Persisted:</span> <span id="cfgPersistedMode">—</span>
            <span class="muted">Runtime:</span> <span id="cfgRuntimeMode">—</span>
            <span class="pill pill--warn hidden" id="cfgRuntimeBadge">Runtime override active</span>
          </div>
          <div class="row">
            <label class="lbl">Mode</label>
            <select class="select" id="cfgMode">
              <option value="mock">mock (default)</option>
              <option value="live">live (reserved)</option>
            </select>
          </div>
          <div class="row">
            <label class="lbl">DSP IP</label>
            <input class="text" id="cfgDspIp" type="text" placeholder="e.g. 192.168.1.50" />
          </div>
          <div class="row">
            <label class="lbl">DSP Port</label>
            <input class="text" id="cfgDspPort" type="number" min="1" max="65535" placeholder="e.g. 48631" />
          </div>
          <div class="row">
            <button class="btn" id="btnCfgLoad">Load</button>
            <button class="btn warn" id="btnCfgSave">Save</button>
          </div>
          <div class="small" id="cfgMsg"></div>
        </div>

        <div class="card">
          <h2>Engine</h2>
          <pre id="engineInfo" class="pre">Loading…</pre>
        </div>

        <div class="card">
          <h2>Watchdog</h2>
          <div class="small" id="watchdogMsg">Loading…</div>
          <pre id="watchdogSystemd" class="pre">Loading…</pre>
          <div class="row">
            
<div class="wd-dsp" id="wdDspSummary">
  <div class="wd-dsp__title">DSP (summary)</div>
  <div class="kv"><span class="k">Mode</span><span class="v" id="wdDspMode">—</span></div>
          <div class="kv"><span class="k">Active</span><span class="v" id="wdDspActiveMode">—</span></div>
  <div class="kv"><span class="k">State</span><span class="v" id="wdDspState">—</span></div>
  <div class="kv"><span class="k">Last test</span><span class="v" id="wdDspLastTest">—</span></div>
  <div class="kv"><span class="k">Last poll</span><span class="v" id="wdDspLastPoll">—</span></div>
  <div class="kv"><span class="k">Failures</span><span class="v" id="wdDspFailures">—</span></div>
  <div class="kv"><span class="k">Validated</span><span class="v" id="wdDspValidated">—</span></div>
  <div class="kv"><span class="k">Last write</span><span class="v" id="wdDspLastWrite">—</span></div>
  <div class="kv"><span class="k">Config</span><span class="v" id="wdDspCfg">—</span></div>
  <div class="wd-dsp__err" id="wdDspErr" style="display:none;"></div>
</div>
<button class="btn" id="btnWatchdogStart">Start watchdog</button>

          </div>
        </div>

        <div class="card">
          <h2>Recent Runtime Events</h2>
          <!--
            UI-only runtime timeline (v0.3.12)

            This records observed state transitions since page load.
            It is intentionally:
              - read-only
              - in-memory only
              - bounded (last ~20 items)

            Purpose: give operators temporal context during troubleshooting
            (watchdog restarts, runtime overrides, connectivity changes, etc.).
          -->
          <div class="small muted">Since page load (UI-only). Helps explain restarts/overrides.</div>
          <pre id="runtimeEvents" class="pre">—</pre>
        </div>

        <div class="card">
          <h2>Debug Snapshot</h2>
          <pre id="stateDump" class="pre">Loading…</pre>
        </div>
      </div>
    </section>
  </main>

  <!-- Cache-buster: keep this in sync with VERSION so browsers pick up new JS after updates -->
  <script src="/app.js?v=0.3.12"></script>
</body>
</html>
